name: wasp build

on:
  push:
    branches: [ "opensaas" ]
  
jobs:
  build:
    runs-on: self-hosted
    environment: production
    env:
      IMAGE: northamerica-northeast1-docker.pkg.dev/therumbler/xxx/showbuddy
      COOLIFY_API_TOKEN: ${{ secrets.COOLIFY_API_TOKEN }}
    
    steps:
    - uses: actions/checkout@v4

    - name: echo $GITHUB_SHA
      run: echo $GITHUB_SHA

    - name: Run wasp build
      run: cd showbuddy/app && /home/brumble/.local/bin/wasp build

    - name: Build Server Docker Image
      run: cd showbuddy/app && docker build ./.wasp/build -t $IMAGE-server:$GITHUB_SHA

    - name: Build Frontend HTML
      run: cd showbuddy/app/.wasp/build/web-app && npm install && REACT_APP_API_URL=https://showbuddy.rmbldc.com npm run build 
    
    # - name: Create Frontend Dockerfile
    #   run: printf "FROM nginx:latest\n\nCOPY showbuddy/app/.wasp/build/web-app/build /usr/share/nginx/html\n" > Dockerfile-frontend

    - name: Build Frontend Docker Image
      run: docker build . -t $IMAGE-frontend:$GITHUB_SHA -f Dockerfile-frontend

    - name: Push Server Docker Image
      run: docker push $IMAGE-server:$GITHUB_SHA
    
    - name: Push Frontend Docker Image
      run: docker push $IMAGE-frontend:$GITHUB_SHA

    - name: Deploy to Coolify
      run: ./scripts/deploy.sh $GITHUB_SHA